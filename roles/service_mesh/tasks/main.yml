---
- name: Ensure Istio control plane namespace exists
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: istio-system
        annotations:
          openshift.io/display-name: 'Service Mesh Control Plane'
      spec: {}

- name: Subscribe to Service Mesh
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: servicemeshoperator
        namespace: openshift-operators
      spec:
        channel: "1.0"
        installPlanApproval: Automatic
        name: servicemeshoperator
        source: redhat-operators
        sourceNamespace: openshift-marketplace

- name: Deploy Service Mesh Control PLane
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition:
      apiVersion: maistra.io/v1
      kind: ServiceMeshControlPlane
      metadata:
        name: basic-install
        namespace: istio-system
      spec:
        istio:
          gateways:
            istio-egressgateway:
              autoscaleEnabled: false
            istio-ingressgateway:
              autoscaleEnabled: false
          grafana:
            enabled: true
          kiali:
            enabled: true
          mixer:
            policy:
              autoscaleEnabled: false
            telemetry:
              autoscaleEnabled: false
          pilot:
            autoscaleEnabled: false
            traceSampling: 100
          tracing:
            enabled: true
            jaeger:
              template: all-in-one
          mtls:
            enabled: true
  register: control_plane_deployment
  until: not control_plane_deployment.failed
  retries: 5
  delay: 10

- name: Retrieve current Service Mesh ConfigMap
  k8s_info:
    kubeconfig: '{{ kubeconfig }}'
    api_version: v1
    namespace: istio-system
    kind: ConfigMap
    name: istio
  register: istio_config_map
  until: istio_config_map.resources|length > 0
  retries: 10
  delay: 30

- name: Enforce policy by default
  k8s:
    kubeconfig: '{{ kubeconfig }}'
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        namespace: istio-system
        name: istio
      data:
        mesh: |
          {% for line in (istio_config_map|json_query("resources[0].data.mesh")).split('\n') %}
          {% if line.startswith('disablePolicyChecks:') -%}
            disablePolicyChecks: false
          {% else -%}
            {{ line }}
          {% endif %}
          {% endfor %}
